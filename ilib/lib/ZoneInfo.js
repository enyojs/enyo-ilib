var _platform="unknown";(function(){if(typeof enyo!=="undefined"){_platform="enyo"}else if(typeof environment!=="undefined"){_platform="rhino"}else if(typeof Qt!=="undefined"){_platform="qt"}else if(typeof process!=="undefined"||typeof require!=="undefined"){_platform="nodejs"}else if(typeof window!=="undefined"){_platform=typeof PalmSystem!=="undefined"?"webos":"browser"}})();var PackedBuffer=PackedBuffer||(_platform==="nodejs"||_platform==="qt"?require("./PackedBuffer.js"):undefined);var ZoneInfoFile=function(e){var i=this;switch(_platform){case"nodejs":var t=require("fs");var n=new Buffer(t.readFileSync(e));var s=new Uint8Array(n);this._parseInfo(s);break;case"qt":var r=require("./ilib.js").getLoader().fr;var n=r.readBinary(e);this._parseInfo(n);break;default:var o=new XMLHttpRequest;o.open("GET","file:"+e,false);o.responseType="arraybuffer";o.onload=function(e){var t=new Uint8Array(o.response);i._parseInfo(t)};o.onerror=function(i){throw"Cannot load file "+e};o.send();break}};ZoneInfoFile.prototype._parseInfo=function(e){var i=new PackedBuffer(e);if(i.getString(4)!="TZif"){throw"file format not recognized"}else{i.skip(16);var t=i.getLong();var n=i.getLong();var s=i.getLong();var r=i.getLong();var o=i.getLong();var a=i.getLong();this.transitionTimes=r?i.getLongs(r):[];this.transitionTimes=this.transitionTimes.map(function(e){return e*1e3});this.ruleIndex=r?i.getUnsignedBytes(r):[];this.zoneInfo=[];for(var f=0;f<o;f++){this.zoneInfo.push({offset:Math.floor(i.getLong()/60),isdst:!!i.getByte(),abbreviationIndex:i.getByte()})}var h=i.getString(a);for(var f=0;f<o;f++){var l=h.substring(this.zoneInfo[f].abbreviationIndex);this.zoneInfo[f].abbreviation=l.substring(0,l.indexOf("\x00"))}if(s){i.skip(s*2)}if(n){i.skip(n)}if(t){i.skip(t)}var d=this;this.ruleIndex=this.ruleIndex.map(function(e){return{offset:d.zoneInfo[e].offset,isdst:d.zoneInfo[e].isdst,abbreviation:d.zoneInfo[e].abbreviation}});for(var f=0;f<r;f++){if(f>0&&this.ruleIndex[f].isdst){this.ruleIndex[f].savings=this.ruleIndex[f].offset-this.ruleIndex[f-1].offset}}if(!this.transitionTimes.length){this.standardTime=this.zoneInfo[0]}else{for(var u=r-1;u>-1;u--){var g=this.ruleIndex[u];if(!this.standardTime&&!g.isdst){this.standardTime=g}else if(!this.daylightTime&&g.isdst){this.daylightTime=g}if(this.daylightTime&&this.standardTime)break}if(this.daylightTime&&!this.standardTime){this.standardTime=this.daylightTime}for(var v=this.zoneInfo.length-1;v>0;v--){if(!this.zoneInfo[v].isdst){this.defaultTime=this.zoneInfo[v];break}}}if(!this.defaultTime){this.defaultTime=this.zoneInfo[this.zoneInfo.length-1]}}};ZoneInfoFile.prototype.bsearch=function(e,i){if(typeof i==="undefined"||!i||typeof e==="undefined"||e<i[0]){return-1}if(e>i[i.length-1]){return i.length-1}var t=i.length-1,n=0,s=0,r;while(n<=t){s=Math.floor((t+n)/2);r=i[s]-e;if(r>0){t=s-1}else if(r<0){n=s+1}else{return s}}return t};ZoneInfoFile.prototype.usesDST=function(e){var i=e.getTime();var t=i+31536e6;var n=this.bsearch(i,this.transitionTimes);if(n!==-1){while(n<this.transitionTimes.length&&this.transitionTimes[n]<t){if(this.ruleIndex[n++].isdst){return true}}}return false};ZoneInfoFile.prototype.getRawOffset=function(e){var i=e.getTime();var t=i+31536e6;var n=this.bsearch(i,this.transitionTimes);var s=this.defaultTime.offset;if(n>-1){while(n<this.transitionTimes.length&&this.ruleIndex[n].isdst&&this.transitionTimes[n+1]<t){n++}if(n<this.transitionTimes.length&&!this.ruleIndex[n].isdst){s=this.ruleIndex[n].offset}}return s};ZoneInfoFile.prototype.getDSTSavings=function(e){var i=e.getTime();var t=i+31536e6;var n=this.bsearch(i,this.transitionTimes);var s=0;if(n>-1){while(n<this.transitionTimes.length&&!this.ruleIndex[n].isdst&&this.transitionTimes[n+1]<t){n++}if(n<this.transitionTimes.length&&this.ruleIndex[n].isdst){s=this.ruleIndex[n].savings}}return s};ZoneInfoFile.prototype.getDSTStartDate=function(e){var i=e.getFullYear();var t=new Date(i,0,1).getTime();var n=new Date(i+1,0,1).getTime();var s=this.bsearch(t,this.transitionTimes);var r=-1;if(s>-1){if(this.transitionTimes[s]<t){s++}while(s<this.transitionTimes.length&&!this.ruleIndex[s].isdst&&this.transitionTimes[s+1]<n){s++}if(s<this.transitionTimes.length&&this.ruleIndex[s].isdst){r=this.transitionTimes[s]}}return r};ZoneInfoFile.prototype.getDSTEndDate=function(e){var i=e.getFullYear();var t=new Date(i,0,1).getTime();var n=new Date(i+1,0,1).getTime();var s=this.bsearch(t,this.transitionTimes);var r=-1;if(s>-1){if(this.transitionTimes[s]<t){s++}while(s<this.transitionTimes.length&&this.ruleIndex[s].isdst&&this.transitionTimes[s+1]<n){s++}if(s<this.transitionTimes.length&&!this.ruleIndex[s].isdst){r=this.transitionTimes[s]}}return r};ZoneInfoFile.prototype.getAbbreviation=function(e){var i=e.getTime();var t=i+31536e6;var n;if(this.transitionTimes.length>0){var s=this.bsearch(i,this.transitionTimes);n=this.ruleIndex[s].abbreviation;if(s>-1){while(s<this.transitionTimes.length&&this.ruleIndex[s].isdst&&this.transitionTimes[s+1]<t){s++}if(s<this.transitionTimes.length&&!this.ruleIndex[s].isdst){n=this.ruleIndex[s].abbreviation}}}else{n=this.standardTime.abbreviation}return n};ZoneInfoFile.prototype.getDSTAbbreviation=function(e){var i=e.getTime();var t=i+31536e6;var n;if(this.transitionTimes.length>0){var s=this.bsearch(i,this.transitionTimes);n=this.ruleIndex[s].abbreviation;if(s>-1){while(s<this.transitionTimes.length&&!this.ruleIndex[s].isdst&&this.transitionTimes[s+1]<t){s++}if(s<this.transitionTimes.length&&this.ruleIndex[s].isdst){n=this.ruleIndex[s].abbreviation}}}else{n=this.standardTime.abbreviation}return n};ZoneInfoFile.prototype.getIlibZoneInfo=function(e){function i(e){var i=Math.floor(e/60);var t=e-i*60;return i+":"+t}function t(e){return 2440587.5+e/864e5}var n={o:i(this.getRawOffset(e))};if(this.usesDST(e)){n.f="{c}";n.e={c:this.getAbbreviation(e),j:t(this.getDSTEndDate(e))};n.s={c:this.getDSTAbbreviation(e),j:t(this.getDSTStartDate(e)),v:i(this.getDSTSavings(e))}}else{n.f=this.getAbbreviation(e)}return n};module.exports=ZoneInfoFile;